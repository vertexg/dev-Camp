# eラーニングシステム AWS構成 パラメータシート

**案件名:** eラーニングシステム構築
**作成日:** 2025年11月17日
**対象リージョン:** 東京リージョン (ap-northeast-1)
---

## 0. プロジェクト基本情報・命名規則

### 基本情報

| 項目                   | 設定値     | 備考 |
| :--------------------- | :--------- | :--- |
| プロジェクト名（英語） | kawausolms |      |
| 環境識別子             | prod       |      |
| システム略称           | kawausolms |      |

### アベイラビリティゾーン（AZ）選定

| 項目           | 設定値          | 備考 |
| :------------- | :-------------- | :--- |
| 使用するAZの数 | 2               |      |
| 第1AZ          | ap-northeast-1a |      |
| 第2AZ          | ap-northeast-1c |      |

### 命名規則適用例

| リソース              | リソース名                          | 備考                   |
| :-------------------- | :---------------------------------- | :--------------------- |
| VPC                   | kawausolms-prod-vpc                 |                        |
| Public Subnet (AZ-1)  | kawausolms-prod-public-1a           | ap-northeast-1a        |
| Public Subnet (AZ-2)  | kawausolms-prod-public-1c           | ap-northeast-1c        |
| Private Subnet App-1  | kawausolms-prod-private-app-1a      | ap-northeast-1a        |
| Private Subnet App-2  | kawausolms-prod-private-app-1c      | ap-northeast-1c        |
| Private Subnet DB-1   | kawausolms-prod-private-db-1a       | ap-northeast-1a        |
| Private Subnet DB-2   | kawausolms-prod-private-db-1c       | ap-northeast-1c        |
| Internet Gateway      | kawausolms-prod-igw                 |                        |
| NAT Gateway (AZ-1)    | kawausolms-prod-natgw-1a            | ap-northeast-1a        |
| NAT Gateway (AZ-2)    | kawausolms-prod-natgw-1c            | ap-northeast-1c        |
| Route Table (Public)  | kawausolms-prod-rtb-public          |                        |
| Route Table (Priv-1)  | kawausolms-prod-rtb-private-1a      | ap-northeast-1a        |
| Route Table (Priv-2)  | kawausolms-prod-rtb-private-1c      | ap-northeast-1c        |
| Security Group (ALB)  | kawausolms-prod-sg-alb              |                        |
| Security Group (EC2)  | kawausolms-prod-sg-ec2              |                        |
| Security Group (RDS)  | kawausolms-prod-sg-rds              |                        |
| ALB                   | kawausolms-prod-alb                 |                        |
| Target Group          | kawausolms-prod-tg-ec2              |                        |
| Launch Template       | kawausolms-prod-lt-ec2              |                        |
| Auto Scaling Group    | kawausolms-prod-asg-ec2             |                        |
| RDS Cluster           | kawausolms-prod-aurora-cluster      |                        |
| RDS Instance (Writer) | kawausolms-prod-aurora-writer       |                        |
| RDS Instance (Reader) | kawausolms-prod-aurora-reader-1     |                        |
| S3 Bucket (教材)      | kawausolms-prod-contents            | グローバルで一意にする |
| S3 Bucket (ログ)      | kawausolms-prod-logs                | グローバルで一意にする |
| S3 Bucket (ALBログ)   | kawausolms-prod-alb-logs            | グローバルで一意にする |
| CloudWatch Log Group  | /aws/kawausolms/prod/application    | パス形式で階層化       |
| IAM Role (EC2)        | kawausolms-prod-role-ec2            |                        |
| IAM Role (RDS)        | kawausolms-prod-role-rds-monitoring |                        |
| SNS Topic             | kawausolms-prod-sns-alerts          |                        |


## 1. システム規模・性能要件

| 項目               | 設定値                                         | 備考                                                                 |
| :----------------- | :--------------------------------------------- | :------------------------------------------------------------------- |
| 同時接続ユーザー数 | 1800人（ピーク時想定）                         | 夕方18時〜夜間22時にアクセス集中                                     |
| 登録ユーザー総数   | 30,000人（保護者・生徒30,000人、講師10,000人） | 将来的な増加も考慮                                                   |
| 動画配信の有無     | 将来計画あり                                   | 初期フェーズでは静的コンテンツのみ、将来的にオンライン授業動画を配信 |
| 動画容量・画質     | 未定（将来計画）                               |                                                                      |
| レスポンス要件     | 3秒以内（ページ表示）      いったん仮置き      | 初期スペックで構築後、負荷テストでチューニング                       |

## 2. Auto Scaling設定

| 項目               | 設定値       | 備考                                                |
| :----------------- | :----------- | :-------------------------------------------------- |
| 最小インスタンス数 | 2台          | 各AZに1台ずつで冗長性確保                           |
| 最大インスタンス数 | 10台         | ピーク時1,800人対応、予算20万円内で運用可能         |
| 希望インスタンス数 | 2台          | 通常時は最小構成で運用                              |
| スケールアウト閾値 | CPU 70%      | AWSのCPU使用率のスケールアウト閾値として70%は一般的 |
| スケールイン閾値   | CPU 30%      | 負荷減少時にコスト最適化                            |
| クールダウン時間   | 300秒（5分） | スケーリングの安定化と過剰反応防止                  |

---

## 3. EC2インスタンス仕様

### 基本設定

| 項目                   | 設定値             | 備考                                     |
| :--------------------- | :----------------- | :--------------------------------------- |
| インスタンスタイプ     | M6a.medium         | 2vCPU, 4GB RAM                           |
| OS                     | Amazon Linux 2023  |                                          |
| アプリケーション言語   | Java               | Javaアプリケーション                     |
| Webサーバー            | Nginx              | 軽量・高性能                             |
| アプリケーション容量   | 5GB程度            | アプリケーション開発会社より確認済み     |
| デプロイ方式           | ゴールデンイメージ | 1台で更新→AMI作成→Auto Scalingで入れ替え |
| AMI更新頻度            | アプリ更新時       | アプリケーション更新のたびにAMI作成      |
| セキュリティパッチ適用 | 月次               | OS・ミドルウェアのセキュリティパッチ     |

### EBSボリューム設定

| 項目                     | 設定値                 | 備考                                                 |
| :----------------------- | :--------------------- | :--------------------------------------------------- |
| ルートボリュームサイズ   | 20GB                   | OS（約8GB）+ Java + アプリ（5GB）                    |
| ボリュームタイプ         | gp3                    | 汎用SSD、コスト効率が良い                            |
| IOPS設定                 | 3,000（デフォルト）    | 標準性能で十分、必要に応じて増強可能                 |
| スループット設定         | 125 MB/s（デフォルト） | 標準性能で十分                                       |
| 追加データボリューム     | なし                   | 永続データはS3に保存、EBS上にデータを残す必要なし    |
| データ保存方針           | S3に全て保存           | 画像等の永続データはS3、EBSにはOS+アプリのみ         |
| EBS暗号化                | 有効（推奨）           | セキュリティベストプラクティス、AWS KMS使用          |
| 暗号化の必要性           | 推奨                   | 一般的なセキュリティ対策として含める                 |
| スナップショット取得頻度 | AMIバックアップに含む  | ゴールデンイメージ作成時に自動取得                   |
| スナップショット保持期間 | 4世代（1ヶ月分）       | AMIと同期、アプリ更新履歴として保持                  |
| 削除時の保護             | 削除（true）           | Auto Scalingで自動削除、ゴールデンイメージ方式に適合 |

### デプロイ方式の詳細

| 項目                   | 設定値                                   | 備考                                      |
| :--------------------- | :--------------------------------------- | :---------------------------------------- |
| デプロイ方式           | ゴールデンイメージ方式                   | AMIベースのデプロイ                       |
| 更新手順               | 1台で更新→AMI作成→Auto Scalingで入れ替え | Blue/Greenデプロイメント的な運用          |
| ゴールデンイメージ作成 | アプリケーション更新時                   | 1台のEC2でアプリ更新後、AMIを作成         |
| Auto Scaling更新       | Launch Template更新                      | 新しいAMIを指定したLaunch Templateに更新  |
| インスタンス入れ替え   | Auto Scalingで自動                       | 古いインスタンスを削除、新しいAMIから起動 |
| ロールバック           | 旧AMIに戻す                              | 問題発生時は前のAMIバージョンに戻す       |
| AMI保持世代数          | 4世代                                    | 直近4回分のアプリバージョンを保持         |

---

## 4. RDS Aurora MySQL構成

### 基本設定

| 項目               | 設定値                            | 備考                                        |
| :----------------- | :-------------------------------- | :------------------------------------------ |
| インスタンスクラス | db.t3.large                       | 2vCPU, 8GB RAM、1,800人対応に適切なスペック |
| エンジンバージョン | Aurora MySQL 3.x（MySQL 8.0互換） | 最新の安定版                                |
| 初期ストレージ容量 | 10GB（自動拡張）                  | Auroraは自動拡張（最大128TB）               |
| Read Replicaの数   | 1〜3台（Auto Scaling）            | Writer 1台 + Reader 1〜3台（自動スケール）  |
| 暗号化             | 有効                              | AWS KMS、セキュリティベストプラクティス     |

### Aurora Replica Auto Scaling設定

| 項目                   | 設定値         | 備考                                                                                                                                                                                              |
| :--------------------- | :------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Auto Scaling有効化     | 有効           | Read Replicaの自動スケーリング                                                                                                                                                                    |
| 最小Reader数           | 1台            | 通常時の最小構成、各AZに配置                                                                                                                                                                      |
| 最大Reader数           | 3台            | ピーク時の最大構成、負荷に応じて自動増減                                                                                                                                                          |
| スケールアウトトリガー | CPU 70%        | CPU使用率が70%を超えたらパフォーマンスが下がる可能性　https://aws.amazon.com/jp/blogs/news/making-better-decisions-about-amazon-rds-with-amazon-cloudwatch-metrics/                               |
| スケールイントリガー   | CPU 30%        | CPU使用率が30%を下回ったらReader削除       CPUが30%以下ということは、ほぼすべてのReplicaが空き状態であることを意味し、1台で十分な負荷を捌ける状況で、2～3台を維持し続けると、無駄なコストが発生。 |
| ターゲットメトリクス   | CPUUtilization | CPU使用率で判断                                                                                                                                                                                   |
| クールダウン時間       | 300秒（5分）   | スケーリングの安定化と過剰反応防止                                                                                                                                                                |
| スケールアウト時間     | 約3〜5分       | Readerインスタンスの起動時間                                                                                                                                                                      |


### メンテナンス設定

| 項目                   | 設定値                 | 備考               |
| :--------------------- | :--------------------- | :----------------- |
| メンテナンスウィンドウ | 土曜日 03:00-04:00 JST | アクセス最小時間帯 |

### ログ設定

| 項目                 | 設定値          | 備考                                                                             |
| :------------------- | :-------------- | :------------------------------------------------------------------------------- |
| ログ利用目的         | 障害調査用      | システム不具合時の原因特定、監査目的のログは不要                                 |
| エラーログ           | 有効            | DBエラー情報の記録、障害調査に必須                                               |
| スロークエリログ     | 有効            | 処理に時間がかかるSQLの記録、パフォーマンス問題特定                              |
| 一般ログ             | 無効            | パフォーマンスへの影響を考慮                                                     |
| 監査ログ             | 無効            | 監査要件なし                                                                     |
| ログ出力先           | CloudWatch Logs | エラーログとスロークエリログをCloudWatch Logsに出力                              |
| ロググループ         | 自動作成        | /aws/rds/cluster/{cluster-name}/error, /aws/rds/cluster/{cluster-name}/slowquery |
| ログ保持期間         | 7日             | CloudWatch Logsでの保持期間                                                      |
| スロークエリ閾値(秒) | 2秒             | long_query_timeパラメータで設定                                                  |

### バックアップ・可用性設定

| 項目                       | 設定値          | 備考                                       |
| :------------------------- | :-------------- | :----------------------------------------- |
| 自動バックアップ           | 有効            | Aurora標準機能、必須                       |
| バックアップ保持期間       | 7日間           | コストと復旧要件のバランス                 |
| バックアップウィンドウ     | 02:00-03:00 JST | アクセス最小時間帯、メンテナンスと重複回避 |
| ポイントインタイムリカバリ | 有効            | 5分以内の任意の時点に復元可能              |
| 削除保護                   | 有効            |                                            |
| 拡張モニタリング           | 有効            | 詳細なパフォーマンスメトリクス取得         |
| 拡張モニタリング粒度       | 60秒間隔        | 標準的な詳細度、コストとのバランス         |

### 認証設定

| 項目                              | 設定値                                      | 備考                                                     |
| :-------------------------------- | :------------------------------------------ | :------------------------------------------------------- |
| データベース認証方法              | ID/パスワード認証                           | 既存構成を踏襲                                           |
| IAMデータベース認証               | 無効                                        | パスワード認証で十分                                     |
| マスターユーザー名                | admin                                       | 緊急時のみ使用                                           |
| マスターパスワード管理            | AWS Secrets Manager（手動管理）             | 特定の場所に保管、通常は使用しない                       |
| マスターパスワード運用方針        | 使用しない                                  | RDS内でアプリケーション用ユーザーを発行して運用          |
| アプリケーション用ユーザー        | RDS内で個別に作成                           | マスターユーザーではなく、権限を制限したユーザーを使用   |
| アプリ用パスワード管理            | AWS Secrets Manager（自動ローテーション可） | アプリケーションが使用する認証情報                       |
| Secrets Manager自動ローテーション | 有効（アプリ用のみ）                        | マスターパスワードはローテーションしない、アプリ用は90日 |
| ローテーション間隔                | 90日（アプリ用ユーザーのみ）                | マスターパスワードは固定、緊急時のみ使用                 |

---

## 5. S3利用

### S3バケット設定（教材データ）

| 項目                   | 設定値                         | 備考                                             |
| :--------------------- | :----------------------------- | :----------------------------------------------- |
| バケット名             | kawausolms-prod-contents       | グローバルで一意                                 |
| 教材データ容量         | 5GB（初期）                    | ユーザー・講師増加に伴い右肩上がりに増加見込み   |
| 月次増加量             | 未定（将来的に増加）           | コンテンツ拡充により増加、定期的な容量監視が必要 |
| アクセス頻度           | 高頻度（ピーク: 18:00-22:00）  | 生徒・保護者のアクセス集中時間帯                 |
| ストレージクラス       | S3 Standard                    | 高頻度アクセスに最適                             |
| バージョニング         | 有効（最新バージョンのみ保持） | 誤削除・上書き保護、旧バージョンは自動削除       |
| ライフサイクルポリシー | 非現行バージョンを即時削除     | 最新バージョンのみ保持、ストレージ容量抑制       |
| バージョン保持期間     | 最新バージョンのみ             | 複数バージョンを持たない構成                     |
| 暗号化                 | 有効（SSE-S3）                 | サーバー側暗号化                                 |

### S3バケット設定（アプリケーションログ）

| 項目                   | 設定値               | 備考                                      |
| :--------------------- | :------------------- | :---------------------------------------- |
| バケット名             | kawausolms-prod-logs | グローバルで一意                          |
| ログ種類               | アプリケーションログ | Javaアプリの動作ログ・エラーログ          |
| ログ利用目的           | 障害調査用           | システム不具合時の原因特定                |
| ログ保持期間           | 90日                 | AWS推奨設定、顧客合意済み                 |
| ライフサイクルポリシー | 90日後に削除         | ストレージコスト削減、自動削除            |
| バージョニング         | 無効                 | ログファイルはバージョン管理不要          |
| 暗号化                 | 有効（SSE-S3）       | サーバー側暗号化                          |
| EC2からの転送          | IAMロール使用        | EC2にS3書き込み権限を付与、ログを自動転送 |

### S3バケット設定（ALBログ）

| 項目             | 設定値                   | 備考                               |
| :--------------- | :----------------------- | :--------------------------------- |
| バケット名       | kawausolms-prod-alb-logs | グローバルで一意                   |
| ログ種類         | ALBアクセスログ          | 誰がいつアクセスしたかを記録       |
| ログ利用目的     | 障害調査用               | アクセスパターン分析、障害時の調査 |
| ALBログ保持期間  | 90日                     | AWS推奨設定、顧客合意済み          |
| ライフサイクル   | 90日後に削除             | ストレージコスト削減、自動削除     |
| バージョニング   | 無効                     | ログファイルはバージョン管理不要   |
| アクセスログ有効 | 有効                     | ALBアクセスログを記録              |
| 暗号化           | 有効（SSE-S3）           | サーバー側暗号化                   |



## 6. ネットワーク・セキュリティ

### VPC基本設定

| 項目                      | 設定値       | 備考                                    |
| :------------------------ | :----------- | :-------------------------------------- |
| VPC CIDR                  | 10.0.0.0/16  | 65,536個のIPアドレス                    |
| IPv6の有効化              | 無効         | IPv4のみで運用                          |
| Public Subnet CIDR (AZ-1) | 10.0.1.0/24  | ap-northeast-1a（256個のIP）            |
| Public Subnet CIDR (AZ-2) | 10.0.2.0/24  | ap-northeast-1c（256個のIP）            |
| Private App CIDR (AZ-1)   | 10.0.11.0/24 | ap-northeast-1a（EC2配置用、256個のIP） |
| Private App CIDR (AZ-2)   | 10.0.12.0/24 | ap-northeast-1c（EC2配置用、256個のIP） |
| Private DB CIDR (AZ-1)    | 10.0.21.0/24 | ap-northeast-1a（RDS配置用、256個のIP） |
| Private DB CIDR (AZ-2)    | 10.0.22.0/24 | ap-northeast-1c（RDS配置用、256個のIP） |
| DNS解決                   | 有効         | enableDnsSupport: true                  |
| DNSホスト名               | 有効         | enableDnsHostnames: true                |

### サブネット設定

| 項目                                           | 設定値 | 備考 |
| :--------------------------------------------- | :----- | :--- |
| パブリックサブネットのパブリックIP自動割り当て | 無効   |      |

### WAF・DDoS対策

| 項目                | 設定値                           | 備考                                              |
| :------------------ | :------------------------------- | :------------------------------------------------ |
| WAFの必要性         | 導入（有効）                     | セキュリティ強化、SQLインジェクション等の攻撃防御 |
| WAF配置場所         | ALBの前段                        | Application Load Balancerに関連付け               |
| WAFマネージドルール | Core Rule Set + Known Bad Inputs | AWSマネージドルールで一般的な脅威対策             |
| レート制限          | 100リクエスト/5分/IP             | DDoS攻撃やブルートフォース攻撃防止                |
| 地理的制限          | 日本のみ許可                     | 国内向けサービスのため、WAF Geo Matchで制御       |
| WAF月額コスト       | 約¥1,200〜¥2,000                 | Web ACL + ルール + リクエスト料金（1,400人対応）  |

### WAF詳細設定

#### Web ACL基本設定

| 項目                      | 設定値                  | 備考                         |
| :------------------------ | :---------------------- | :--------------------------- |
| Web ACL名                 | kawausolms-prod-waf-acl | WAF Web ACL                  |
| リソースタイプ            | Regional resources      | ALB用                        |
| リージョン                | ap-northeast-1          | 東京リージョン               |
| 関連付けられたAWSリソース | kawausolms-prod-alb     | Application Load Balancer    |
| デフォルトアクション      | Allow                   | ルールに一致しない場合は許可 |
| CloudWatch メトリクス     | 有効                    | WAFメトリクスを監視          |
| サンプルリクエスト        | 有効                    |                              |

#### ルール設定

| ルール名                             | タイプ           | 優先度 | アクション | 説明                             |
| :----------------------------------- | :--------------- | :----- | :--------- | :------------------------------- |
| AWSManagedRulesCommonRuleSet         | マネージドルール | 0      | Block      | Core Rule Set、一般的な脅威対策  |
| AWSManagedRulesKnownBadInputsRuleSet | マネージドルール | 1      | Block      | 既知の不正入力パターン対策       |
| AWSManagedRulesSQLiRuleSet           | マネージドルール | 2      | Block      | SQLインジェクション対策          |
| RateLimitRule                        | Rate-based rule  | 3      | Block      | 100リクエスト/5分/IP             |
| GeoMatchRule                         | Regular rule     | 4      | Block      | 日本以外からのアクセスをブロック |

#### ログ設定

| 項目           | 設定値                       | 備考                |
| :------------- | :--------------------------- | :------------------ |
| ログ記録       | 有効                         |                     |
| ログ送信先     | CloudWatch Logs              |                     |
| ロググループ名 | aws-waf-logs-kawausolms-prod | WAF専用ロググループ |
| ログ保持期間   | 30日                         | セキュリティ監査用  |
| ログフィールド | すべてのフィールド           |                     |

### IAMロール設定

#### EC2用IAMロール

| 項目                 | 設定値                                          | 備考                                                      |
| :------------------- | :---------------------------------------------- | :-------------------------------------------------------- |
| ロール名             | kawausolms-prod-role-ec2                        | EC2インスタンスにアタッチ                                 |
| 権限設計方針         | 最小権限の原則                                  | 必要最小限の権限のみ付与                                  |
| Systems Manager権限  | AmazonSSMManagedInstanceCore（AWS管理ポリシー） | SSM経由のアクセス、パッチ管理、必須                       |
| S3アクセス権限       | 教材バケット（PutObject, GetObject）            | 教材コンテンツの保存・読み取り                            |
| S3バケット制限       | kawausolms-prod-contents のみ                   | 特定バケットのみアクセス可能                              |
| CloudWatch Agent権限 | CloudWatchAgentServerPolicy（AWS管理ポリシー）  | CloudWatch Agentがメトリクスとログを送信するため          |
| CloudWatch Logs権限  | CreateLogGroup, CreateLogStream, PutLogEvents   | アプリケーションログ・システムログをCloudWatch Logsに送信 |
| ロググループ制限     | /aws/kawausolms/prod/* のみ                     | 特定ロググループのみアクセス可能                          |
| Secrets Manager権限  | GetSecretValue（特定シークレットのみ）          | DB認証情報の取得、アプリ用ユーザーのみ                    |
| シークレット制限     | kawausolms-prod-db-app-user のみ                | マスターパスワードへのアクセスは不可                      |

### セキュリティグループ設定

#### ALB用セキュリティグループ

| 項目                   | 設定値                 | 備考                                                    |
| :--------------------- | :--------------------- | :------------------------------------------------------ |
| セキュリティグループ名 | kawausolms-prod-sg-alb | ALB用セキュリティグループ                               |
| 基本方針               | HTTPSのみ公開          | セキュリティ重視、暗号化されていない通信はブロック      |
| HTTP許可               | 無効（ブロック）       | HTTP (80)は許可しない方針で合意                         |
| HTTPS許可              | 有効（必須）           | HTTPS (443)のみ許可、ユーザーからのアクセスを受け付ける |
| アクセス元IP制限       | なし                   | 生徒・保護者が自宅等の様々なネットワークからアクセス    |
| 許可するIP範囲         | 0.0.0.0/0              | インターネット全体に公開（不特定多数のアクセスを想定）  |
| WAF導入                | 有効（導入）           | ALBの前段に配置、セキュリティ強化                       |

**インバウンドルール:**

| タイプ | プロトコル | ポート範囲 | ソース    | 説明                                                 |
| :----- | :--------- | :--------- | :-------- | :--------------------------------------------------- |
| HTTPS  | TCP        | 443        | 0.0.0.0/0 | ユーザー（生徒・保護者・講師）からのアクセス（必須） |

**アウトバウンドルール:**

| タイプ | プロトコル | ポート範囲 | 送信先                 | 説明                                                       |
| :----- | :--------- | :--------- | :--------------------- | :--------------------------------------------------------- |
| HTTP   | TCP        | 80         | kawausolms-prod-sg-ec2 | EC2への転送、SSL終端はALBで行いEC2へはHTTPで通信（一般的） |

#### EC2用セキュリティグループ

| 項目                   | 設定値                       | 備考                                                  |
| :--------------------- | :--------------------------- | :---------------------------------------------------- |
| セキュリティグループ名 | kawausolms-prod-sg-ec2       | EC2インスタンス用（命名規則: KawausoLMS-Prod-App-SG） |
| 基本方針               | ALBからの通信のみ許可        | 外部からの直接アクセスは不可                          |
| アプリケーションポート | 80                           | ALBからのHTTP通信（Javaアプリ構成により調整可能）     |
| ALBからのアクセス      | 許可（必須）                 | ALB SGからのみ許可                                    |
| SSH接続                | 予備手段として設定           | 日常的にはSystems Manager (Session Manager)を使用     |
| SSH接続元IP            | 開発会社の固定IP（後日共有） | 緊急時・保守対応用、IP制限付き                        |
| 管理アクセス方針       | Systems Manager優先          | SSHはあくまでバックアップ手段                         |
| 内部通信               | 不要                         | EC2間の通信は不要                                     |

**インバウンドルール:**

| タイプ | プロトコル | ポート範囲 | ソース                     | 説明                                        |
| :----- | :--------- | :--------- | :------------------------- | :------------------------------------------ |
| HTTP   | TCP        | 80         | kawausolms-prod-sg-alb     | ALBからのアプリケーション通信（必須）       |
| SSH    | TCP        | 22         | 開発会社固定IP（後日共有） | 【予備】保守・緊急対応用、SSM利用不可時のみ |

**アウトバウンドルール:**

| タイプ       | プロトコル | ポート範囲 | 送信先                 | 説明                                             |
| :----------- | :--------- | :--------- | :--------------------- | :----------------------------------------------- |
| HTTPS        | TCP        | 443        | 0.0.0.0/0              | OSアップデート、AWS API（S3, CloudWatch Logs等） |
| MySQL/Aurora | TCP        | 3306       | kawausolms-prod-sg-rds | RDSへのDB接続                                    |

#### RDS用セキュリティグループ

| 項目                   | 設定値                 | 備考                          |
| :--------------------- | :--------------------- | :---------------------------- |
| セキュリティグループ名 | kawausolms-prod-sg-rds | RDS Aurora用                  |
| データベースポート     | 3306                   | MySQL/Aurora標準ポート        |
| EC2からのアクセス      | 許可                   | EC2 SGからのみ                |
| 管理者アクセス         | 不許可（本番環境）     | 本番環境では直接接続不可      |
| 管理者接続元IP         | なし                   | 本番環境ではSSM経由でのみ接続 |

**インバウンドルール:**

| タイプ       | プロトコル | ポート範囲 | ソース                 | 説明            |
| :----------- | :--------- | :--------- | :--------------------- | :-------------- |
| MySQL/Aurora | TCP        | 3306       | kawausolms-prod-sg-ec2 | EC2からのDB接続 |

**アウトバウンドルール:**

| タイプ | プロトコル | ポート範囲 | 送信先 | 説明                    |
| :----- | :--------- | :--------- | :----- | :---------------------- |
| なし   | -          | -          | -      | RDSからの外部接続は不要 |

### EC2アクセス方法の設定

| 項目             | 設定値                | 備考                               |
| :--------------- | :-------------------- | :--------------------------------- |
| 主要アクセス方法 | Systems Manager (SSM) | セキュアかつコスト効率的           |
| 予備アクセス方法 | SSH公開鍵認証         | SSM障害時のフェイルオーバー手段    |
| SSH接続元IP制限  | 有効                  | 管理者IPのみ許可                   |
| SSH接続元IP一覧  | 運用時に設定          | 環境構築後、管理者から公開鍵を収集 |
| SSHポート番号    | 22                    | 標準ポート                         |

---

## 8. 監視・アラート（CloudWatch）

### 監視設定

| 項目                             | 設定値                                         | 備考                                 |
| :------------------------------- | :--------------------------------------------- | :----------------------------------- |
| 監視項目                         | CPU、メモリ、ディスク、ネットワーク、RDS接続数 | システムの健全性とパフォーマンス監視 |
| CPU使用率アラート（Warning）     | 70%                                            | リソース不足の早期検知               |
| CPU使用率アラート（Critical）    | 85%                                            | 緊急対応が必要                       |
| メモリ使用率アラート（Warning）  | 80%                                            | メモリ枯渇の早期検知                 |
| メモリ使用率アラート（Critical） | 90%                                            | サービス停止の危険性                 |
| RDS接続数アラート                | 最大接続数の80%                                | 接続プール枯渇防止                   |
| カスタムメトリクス               | メモリ使用率のみ                               | CloudWatch Agent使用、コスト考慮     |

### アラート通知設定

| 項目                 | 設定値                     | 備考                       |
| :------------------- | :------------------------- | :------------------------- |
| アラート通知先       | Email + SNS                | 複数チャネルで通知         |
| 通知先メールアドレス | 運用時に設定               | 運用担当者のメールアドレス |
| Slack Webhook URL    | 運用時に設定（オプション） | Slack連携する場合          |
| SNS Topic ARN        | kawausolms-prod-sns-alerts | CloudWatchアラームから通知 |

### ログ設定

| 項目                    | 設定値        | 備考                                             |
| :---------------------- | :------------ | :----------------------------------------------- |
| ログ利用目的            | 障害調査用    | システム不具合時の原因特定、監査目的のログは不要 |
| ログ保存場所            | Amazon S3     | 全ログをS3に保存、コスト効率が良い               |
| ログ保持期間            | 90日          | AWS推奨設定、顧客合意済み                        |
| CloudWatch Logs経由     | 一時的に使用  | リアルタイム監視用、その後S3へアーカイブ         |
| CloudWatch Logs保持期間 | 7日           | リアルタイム監視用、7日後にS3へエクスポート      |
| アプリケーションログ    | 有効          | Javaアプリの動作ログ・エラーログ                 |
| システムログ            | 有効          | /var/log/messages等、OS・ミドルウェアのログ      |
| EC2からS3への転送       | IAMロール使用 | EC2にS3書き込み権限を付与、ログを自動転送        |

### CloudWatch Agent設定（EC2）

| 項目               | 設定値 | 備考                            |
| :----------------- | :----- | :------------------------------ |
| メトリクス収集間隔 | 60秒   |                                 |
| メモリ使用率       | 有効   | カスタムメトリクス              |
| ディスク使用率     | 有効   | カスタムメトリクス              |
| ログ収集           | 有効   | /var/log/messages, アプリログ等 |

---

## 9. ドメイン・DNS（Route 53）

| 項目             | 設定値                           | 備考                              |
| :--------------- | :------------------------------- | :-------------------------------- |
| ドメイン名       | kawausolms.com                   | メインドメイン                    |
| サブドメイン構成 | www.kawausolms.com               | Webサイト用                       |
| ホストゾーン     | 新規作成                         | Route 53でホストゾーン作成        |
| TTL設定          | 300秒（構築時）→3600秒（本番後） | DNS変更の反映速度とキャッシュ制御 |

### DNSレコード設定

| レコードタイプ | 名前               | 値                      | TTL  | 備考                              |
| :------------- | :----------------- | :---------------------- | :--- | :-------------------------------- |
| A              | kawausolms.com     | ALB（Alias）            | -    | ルートドメイン（動的コンテンツ）  |
| A              | www.kawausolms.com | ALB（Alias）            | -    | wwwサブドメイン（動的コンテンツ） |
| CNAME          | cdn.kawausolms.com | CloudFront（Alias推奨） | 300  | 静的コンテンツ配信用              |
| CNAME          | _acm-validation    | ACM検証用               | 300  | SSL証明書検証用（自動）           |

---

## 10. SSL/TLS証明書（ACM）

### ALB用証明書（ap-northeast-1）

| 項目           | 設定値                           | 備考                               |
| :------------- | :------------------------------- | :--------------------------------- |
| 証明書の種類   | ワイルドカード証明書             | *.kawausolms.com                   |
| 証明書検証方法 | DNS検証                          | 自動更新が容易、Route 53と連携     |
| 対象ドメイン   | kawausolms.com, *.kawausolms.com | ルートドメインとサブドメイン全対応 |
| リージョン     | ap-northeast-1                   | 東京リージョン（ALB用）            |

### CloudFront用証明書（us-east-1）

| 項目           | 設定値             | 備考                               |
| :------------- | :----------------- | :--------------------------------- |
| 証明書の種類   | 単一ドメイン証明書 | cdn.kawausolms.com                 |
| 証明書検証方法 | DNS検証            | 自動更新が容易、Route 53と連携     |
| 対象ドメイン   | cdn.kawausolms.com | CloudFront用サブドメイン           |
| リージョン     | us-east-1          | バージニア北部（CloudFrontは必須） |

---

## 11. コスト管理・予算

### 予算設定

| 項目                  | 設定値   | 備考                                  |
| :-------------------- | :------- | :------------------------------------ |
| 月額予算上限          | ¥200,000 | 月額20万円を目安                      |
| 初期構築費用          | 別途見積 | 設計・構築・テスト費用                |
| コストアラート（50%） | ¥100,000 | 予算の50%で早期警告通知               |
| コストアラート（75%） | ¥150,000 | 予算の75%で警告通知、コスト見直し検討 |


## 12. バックアップ・災害対策

| 項目                           | 設定値                     | 備考                                                                                              |
| :----------------------------- | :------------------------- | :------------------------------------------------------------------------------------------------ |
| RTO（目標復旧時間）            | 12時間以内                 | ビジネス要件として12時間以内の復旧を目標                                                          |
| RPO（目標復旧時点）            | 24時間以内                 | ビジネス要件として24時間以内のデータ損失を許容                                                    |
| EBSバックアップ頻度（DLM利用） | 日次（毎日 04:00 JST）     | RPO 24時間要件を満たすため必須、深夜帯に自動取得、日々の復旧はEBSスナップショットで行う運用とする |
| AMIバックアップ頻度            | 月次 または アプリ更新時   | システム構成が大きく変わった時用として補助的に取得、フルイメージバックアップ                      |
| EBS/AMI保持世代数              | 3〜5世代                   | 直近数日分あれば復旧には十分であり、ストレージコストを抑えるため                                  |
| バックアップ通知先             | kawausolms-prod-sns-alerts | バックアップ成功・失敗をSNS経由でメール通知                                                       |

### バックアップスケジュール

| バックアップ対象     | 頻度         | 実行時刻        | 保持期間 | 備考                                                 |
| :------------------- | :----------- | :-------------- | :------- | :--------------------------------------------------- |
| RDS自動バックアップ  | 継続的       | 02:00-03:00 JST | 7日間    | Aurora標準機能、PITR対応                             |
| EBS スナップショット | 日次         | 毎日 04:00 JST  | 3〜5世代 | DLM（Data Lifecycle Manager）利用、日々の復旧用      |
| EC2 AMI              | 月次/手動    | 月初 01:00 JST  | 3〜5世代 | システム構成変更時の補助的バックアップ、フルイメージ |
| S3バージョニング     | リアルタイム | -               | 無期限   | 教材データの誤削除・上書き保護                       |


{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowReadContents",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::kawausolms-prod-contents",
                "arn:aws:s3:::kawausolms-prod-contents/*"
            ]
        },
        {
            "Sid": "AllowWriteLogs",
            "Effect": "Allow",
            "Action": [
                "s3:PutObject"
            ],
            "Resource": "arn:aws:s3:::kawausolms-prod-logs/*"
        },
        {
            "Sid": "AllowGetSecret",
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetSecretValue"
            ],
            "Resource": "arn:aws:secretsmanager:ap-northeast-1:*:secret:kawausolms-prod-db-app-user-*"
        }
    ]
}
