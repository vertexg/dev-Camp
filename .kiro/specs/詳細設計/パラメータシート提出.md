## パラメータ

## VPC

| 項目                 | 設定値              | 備考       |
| -------------------- | ------------------- | ---------- |
| 名前タグ             | kawausolms-prod-vpc |            |
| IPv4 CIDR ブロック   | 10.0.0.0/16         | IPv6無効化 |
| IPv6 CIDR ブロック   | なし                |            |
| テナンシー           | デフォルト          |            |
| DNS 解決を有効化     | 有効                |            |
| DNS ホスト名を有効化 | 有効                |            |

---

## Internet Gateway

| 項目            | 設定値              | 備考 |
| --------------- | ------------------- | ---- |
| 名前タグ        | kawausolms-prod-igw |      |
| アタッチするVPC | kawausolms-prod-vpc |      |

---

## NAT Gateway

### NAT Gateway 1 (AZ-1)

| 項目       | 設定値                    | 備考            |
| ---------- | ------------------------- | --------------- |
| 名前       | kawausolms-prod-natgw-1a  |                 |
| サブネット | kawausolms-prod-public-1a | ap-northeast-1a |
| 接続タイプ | パブリック                |                 |
| Elastic IP | 自動                      |                 |

### NAT Gateway 2 (AZ-2)

| 項目       | 設定値                    | 備考            |
| ---------- | ------------------------- | --------------- |
| 名前       | kawausolms-prod-natgw-1c  |                 |
| サブネット | kawausolms-prod-public-1c | ap-northeast-1c |
| 接続タイプ | パブリック                |                 |
| Elastic IP | 自動                      |                 |

---

## サブネット

### Public Subnet (AZ-1)

| 項目                                   | 設定値                    | 備考      |
| -------------------------------------- | ------------------------- | --------- |
| サブネット名                           | kawausolms-prod-public-1a |           |
| VPC                                    | kawausolms-prod-vpc       |           |
| アベイラビリティーゾーン               | ap-northeast-1a           |           |
| IPv4 CIDR ブロック                     | 10.0.1.0/24               | 256個のIP |
| パブリック IPv4 アドレスの自動割り当て | 有効                      |           |

### Public Subnet (AZ-2)

| 項目                                   | 設定値                    | 備考      |
| -------------------------------------- | ------------------------- | --------- |
| サブネット名                           | kawausolms-prod-public-1c |           |
| VPC                                    | kawausolms-prod-vpc       |           |
| アベイラビリティーゾーン               | ap-northeast-1c           |           |
| IPv4 CIDR ブロック                     | 10.0.2.0/24               | 256個のIP |
| パブリック IPv4 アドレスの自動割り当て | 有効                      |           |

### Private Subnet App (AZ-1)

| 項目                     | 設定値                         | 備考      |
| ------------------------ | ------------------------------ | --------- |
| サブネット名             | kawausolms-prod-private-app-1a |           |
| VPC                      | kawausolms-prod-vpc            |           |
| アベイラビリティーゾーン | ap-northeast-1a                |           |
| IPv4 CIDR ブロック       | 10.0.11.0/24                   | 256個のIP |

### Private Subnet App (AZ-2)

| 項目                     | 設定値                         | 備考      |
| ------------------------ | ------------------------------ | --------- |
| サブネット名             | kawausolms-prod-private-app-1c |           |
| VPC                      | kawausolms-prod-vpc            |           |
| アベイラビリティーゾーン | ap-northeast-1c                |           |
| IPv4 CIDR ブロック       | 10.0.12.0/24                   | 256個のIP |

### Private Subnet DB (AZ-1)

| 項目                     | 設定値                        | 備考      |
| ------------------------ | ----------------------------- | --------- |
| サブネット名             | kawausolms-prod-private-db-1a |           |
| VPC                      | kawausolms-prod-vpc           |           |
| アベイラビリティーゾーン | ap-northeast-1a               |           |
| IPv4 CIDR ブロック       | 10.0.21.0/24                  | 256個のIP |

### Private Subnet DB (AZ-2)

| 項目                     | 設定値                        | 備考      |
| ------------------------ | ----------------------------- | --------- |
| サブネット名             | kawausolms-prod-private-db-1c |           |
| VPC                      | kawausolms-prod-vpc           |           |
| アベイラビリティーゾーン | ap-northeast-1c               |           |
| IPv4 CIDR ブロック       | 10.0.22.0/24                  | 256個のIP |

---

## ルートテーブル

### Public Route Table

| 項目 | 設定値                     | 備考 |
| ---- | -------------------------- | ---- |
| 名前 | kawausolms-prod-rtb-public |      |
| VPC  | kawausolms-prod-vpc        |      |

**ルート:**

| 送信先      | ターゲット          | 備考 |
| ----------- | ------------------- | ---- |
| 10.0.0.0/16 | local               |      |
| 0.0.0.0/0   | kawausolms-prod-igw |      |

**サブネットの関連付け:**

- kawausolms-prod-public-1a
- kawausolms-prod-public-1c

### Private Route Table (AZ-1)

| 項目 | 設定値                         | 備考 |
| ---- | ------------------------------ | ---- |
| 名前 | kawausolms-prod-rtb-private-1a |      |
| VPC  | kawausolms-prod-vpc            |      |

**ルート:**

| 送信先      | ターゲット               | 備考 |
| ----------- | ------------------------ | ---- |
| 10.0.0.0/16 | local                    |      |
| 0.0.0.0/0   | kawausolms-prod-natgw-1a |      |

**サブネットの関連付け:**

- kawausolms-prod-private-app-1a

### Private Route Table (AZ-2)

| 項目 | 設定値                         | 備考 |
| ---- | ------------------------------ | ---- |
| 名前 | kawausolms-prod-rtb-private-1c |      |
| VPC  | kawausolms-prod-vpc            |      |

**ルート:**

| 送信先      | ターゲット               | 備考 |
| ----------- | ------------------------ | ---- |
| 10.0.0.0/16 | local                    |      |
| 0.0.0.0/0   | kawausolms-prod-natgw-1c |      |

**サブネットの関連付け:**

- kawausolms-prod-private-app-1c

---

---

## セキュリティグループ

| セキュリティグループ名 | 用途                        | 備考                      |
| ---------------------- | --------------------------- | ------------------------- |
| kawausolms-prod-sg-alb | ALB用のセキュリティグループ | kawausolms-prod-vpcで作成 |
| kawausolms-prod-sg-ec2 | EC2用のセキュリティグループ | kawausolms-prod-vpcで作成 |
| kawausolms-prod-sg-rds | RDS用のセキュリティグループ | kawausolms-prod-vpcで作成 |

### kawausolms-prod-sg-alb

| 項目                   | 設定値                 | 備考 |
| ---------------------- | ---------------------- | ---- |
| セキュリティグループ名 | kawausolms-prod-sg-alb |      |
| 説明                   | Security group for ALB |      |
| VPC                    | kawausolms-prod-vpc    |      |

**インバウンドルール:**

| タイプ | プロトコル | ポート範囲 | ソース    | 説明                                         |
| ------ | ---------- | ---------- | --------- | -------------------------------------------- |
| HTTPS  | TCP        | 443        | 0.0.0.0/0 | ユーザー（生徒・保護者・講師）からのアクセス |

**アウトバウンドルール:**

| タイプ | プロトコル | ポート範囲 | 送信先                 | 説明        |
| ------ | ---------- | ---------- | ---------------------- | ----------- |
| HTTP   | TCP        | 80         | kawausolms-prod-sg-ec2 | EC2への転送 |

### kawausolms-prod-sg-ec2

| 項目                   | 設定値                 | 備考 |
| ---------------------- | ---------------------- | ---- |
| セキュリティグループ名 | kawausolms-prod-sg-ec2 |      |
| 説明                   | Security group for EC2 |      |
| VPC                    | kawausolms-prod-vpc    |      |

**インバウンドルール:**

| タイプ | プロトコル | ポート範囲 | ソース                     | 説明                                        |
| ------ | ---------- | ---------- | -------------------------- | ------------------------------------------- |
| HTTP   | TCP        | 80         | kawausolms-prod-sg-alb     | ALBからのアプリケーション通信               |
| SSH    | TCP        | 22         | 開発会社固定IP（後日共有） | 【予備】保守・緊急対応用、SSM利用不可時のみ |

**アウトバウンドルール:**

| タイプ       | プロトコル | ポート範囲 | 送信先                 | 説明                                             |
| ------------ | ---------- | ---------- | ---------------------- | ------------------------------------------------ |
| HTTPS        | TCP        | 443        | 0.0.0.0/0              | OSアップデート、AWS API（S3, CloudWatch Logs等） |
| MySQL/Aurora | TCP        | 3306       | kawausolms-prod-sg-rds | RDSへのDB接続                                    |

### kawausolms-prod-sg-rds

| 項目                   | 設定値                 | 備考 |
| ---------------------- | ---------------------- | ---- |
| セキュリティグループ名 | kawausolms-prod-sg-rds |      |
| 説明                   | Security group for RDS |      |
| VPC                    | kawausolms-prod-vpc    |      |

**インバウンドルール:**

| タイプ       | プロトコル | ポート範囲 | ソース                 | 説明            |
| ------------ | ---------- | ---------- | ---------------------- | --------------- |
| MySQL/Aurora | TCP        | 3306       | kawausolms-prod-sg-ec2 | EC2からのDB接続 |

**アウトバウンドルール:**

| タイプ | プロトコル | ポート範囲 | 送信先 | 説明                    |
| ------ | ---------- | ---------- | ------ | ----------------------- |
| なし   | -          | -          | -      | RDSからの外部接続は不要 |

---

---

## IAMロール

### EC2用IAMロール

| 項目                         | 設定値                   | 備考                   |
| ---------------------------- | ------------------------ | ---------------------- |
| ロール名                     | kawausolms-prod-role-ec2 |                        |
| 信頼されたエンティティタイプ | AWSのサービス            |                        |
| ユースケース                 | EC2                      | 実行を許可するサービス |

**** |

```markdown
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowReadContents",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket",
                "s3:DeleteObject"
            ],
            "Resource": [
                "arn:aws:s3:::kawausolms-prod-contents",
                "arn:aws:s3:::kawausolms-prod-contents/*"
            ]
        },
        {
            "Sid": "AllowWriteLogs",
            "Effect": "Allow",
            "Action": [
                "s3:PutObject"
            ],
            "Resource": "arn:aws:s3:::kawausolms-prod-logs/*"
        },
        {
            "Sid": "AllowGetSecret",
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetSecretValue"
            ],
            "Resource": "arn:aws:secretsmanager:ap-northeast-1:*:secret:kawausolms-prod-db-app-user-*"
        }
    ]
}
```

**アタッチするマネージドポリシー:**

| ポリシー名                   | 用途                                   | 備考 |
| ---------------------------- | -------------------------------------- | ---- |
| AmazonSSMManagedInstanceCore | EC2へSession managerでログインするため |      |

**アタッチするマネージドポリシー（CloudWatch Agent用）:**

| ポリシー名                  | 用途                                             | 備考 |
| --------------------------- | ------------------------------------------------ | ---- |
| CloudWatchAgentServerPolicy | CloudWatch Agentがメトリクスとログを送信するため |      |

---

### 起動テンプレート

| 項目                         | 設定値                   | 備考                                                                                                                               |
| ---------------------------- | ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------- |
| 起動テンプレート名           | kawausolms-prod-lt-ec2   |                                                                                                                                    |
| テンプレートバージョンの説明 | Initial version          |                                                                                                                                    |
| AMI                          | Amazon Linux 2023        | 最新版を使用                                                                                                                       |
| インスタンスタイプ           | m6i.large                | `g` (Graviton/ARM系) を採用するとコスト効率が良いが、もしアプリケーションが ARMアーキテクチャに対応していない場合を考慮し、gは除外 |
| IAMインスタンスプロファイル  | kawausolms-prod-role-ec2 | SSM接続、S3アクセス、CloudWatch Logsへのログ出力に必要                                                                             |
| キーペア (ログイン)          | kawausolms-prod-key      | SSM利用不可時の予備SSH接続用（事前に作成が必要）                                                                                   |
| ネットワークタイプ           | VPC                      |                                                                                                                                    |
| セキュリティグループ         | kawausolms-prod-sg-ec2   |                                                                                                                                    |

**ユーザーデータ（オプション）:**

```bash
#!/bin/bash

# 1. システムを最新化
dnf update -y

# 2. Nginx をインストール
dnf install -y nginx

```

**ストレージ（ボリューム）:**

| 項目             | 設定値    | 備考        |
| ---------------- | --------- | ----------- |
| デバイス名       | /dev/xvda |             |
| スナップショット | なし      |             |
| ボリュームタイプ | gp3       |             |
| ボリュームサイズ | 20 GiB    |             |
| IOPS             | 3000      |             |
| スループット     | 125 MB/s  |             |
| 暗号化           | 有効      | AWS KMS使用 |
| 終了時に削除     | はい      |             |

### Auto Scaling Group

| 項目                    | 設定値                                                                                          | 備考           |
| ----------------------- | ----------------------------------------------------------------------------------------------- | -------------- |
| Auto Scaling グループ名 | kawausolms-prod-asg-ec2                                                                         |                |
| Launch Template         | kawausolms-prod-lt-ec2                                                                          | 最新バージョン |
| VPC                     | kawausolms-prod-vpc                                                                             |                |
| AZとサブネット          | kawausolms-prod-private-app-1a, kawausolms-prod-private-app-1c ap-northeast-1a, ap-northeast-1c |                |
| ロードバランシング      | 既存のロードバランサーにアタッチ                                                                |                |
| ターゲットグループ      | kawausolms-prod-tg-ec2                                                                          |                |
| ヘルスチェックタイプ    | ELB                                                                                             |                |
| ヘルスチェック猶予期間  | 300秒                                                                                           |                |

**グループサイズ:**

| 項目             | 設定値 | 備考 |
| ---------------- | ------ | ---- |
| 希望する容量     | 2      |      |
| 最小キャパシティ | 2      |      |
| 最大キャパシティ | 6      |      |

**スケーリングポリシー:**

ポリシー名: `kawausolms-prod-asg-scaling-policy`

| 項目                         | 設定値                     | 備考 |
| ---------------------------- | -------------------------- | ---- |
| ポリシータイプ               | ターゲット追跡スケーリング |      |
| メトリクスタイプ             | 平均CPU使用率              |      |
| ターゲット値                 | 70                         | 70%  |
| インスタンスのウォームアップ | 300秒                      |      |

---


## Application Load Balancer (ALB)

### ロードバランサー

| 項目                     | 設定値                                               | 備考                             |
| ------------------------ | ---------------------------------------------------- | -------------------------------- |
| ロードバランサー名       | kawausolms-prod-alb                                  |                                  |
| スキーム                 | インターネット向け                                   |                                  |
| IP アドレスタイプ        | IPv4                                                 |                                  |
| VPC                      | kawausolms-prod-vpc                                  |                                  |
| マッピング（サブネット） | kawausolms-prod-public-1a, kawausolms-prod-public-1c | ap-northeast-1a, ap-northeast-1c |
| セキュリティグループ     | kawausolms-prod-sg-alb                               |                                  |
| アクセスログ             | 有効 (kawausolms-prod-alb-logs)                      |                                  |


### ターゲットグループ

| 項目                 | 設定値                 | 備考 |
| -------------------- | ---------------------- | ---- |
| ターゲットタイプ     | インスタンス           |      |
| ターゲットグループ名 | kawausolms-prod-tg-ec2 |      |
| プロトコル           | HTTP                   |      |
| プロトコルバージョン | HTTP1                  |      |
| ポート               | 80                     |      |
| VPC                  | kawausolms-prod-vpc    |      |
| IP アドレスタイプ    | IPv4                   |      |

**ヘルスチェック:**

| 項目                     | 設定値             | 備考       |
| ------------------------ | ------------------ | ---------- |
| ヘルスチェックプロトコル | HTTP               |            |
| ヘルスチェックパス       | /                  |            |
| ポート                   | トラフィックポート | 80番を使用 |
| 正常のしきい値           | 5                  |            |
| 非正常のしきい値         | 2                  |            |
| タイムアウト             | 5秒                |            |
| 間隔                     | 30秒               |            |
| 成功コード               | 200                |            |

### リスナー

| 項目                 | 設定値                              | 備考                      |
| -------------------- | ----------------------------------- | ------------------------- |
| プロトコル           | HTTPS                               |                           |
| ポート               | 443                                 |                           |
| デフォルトアクション | Forward                             | to kawausolms-prod-tg-ec2 |
| SSL証明書            | ACM証明書                           | *.kawausolms.com          |
| セキュリティポリシー | ELBSecurityPolicy-TLS13-1-2-2021-06 | 推奨ポリシー              |

---

## RDS Aurora MySQL

### DBサブネットグループ

| 項目       | 設定値                                                       | 備考 |
| ---------- | ------------------------------------------------------------ | ---- |
| 名前       | kawausolms-prod-rds-subnet-group                             |      |
| 説明       | Subnet group for Aurora MySQL                                |      |
| VPC        | kawausolms-prod-vpc                                          |      |
| サブネット | kawausolms-prod-private-db-1a, kawausolms-prod-private-db-1c |      |

### DBインスタンス

| 項目                    | 設定値                               | 備考                                                                                                                                                 |
| ----------------------- | ------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| エンジンのタイプ        | Amazon Aurora                        |                                                                                                                                                      |
| エンジンバージョン      | Aurora MySQL 3.08.2（MySQL 8.0互換） |                                                                                                                                                      |
| DBクラスター識別子      | kawausolms-prod-aurora-cluster       |                                                                                                                                                      |
| マスターユーザー名      | admin                                | 緊急時のみ使用                                                                                                                                       |
| マスターパスワード      | （Secrets Managerで管理）            | 手動管理、通常は使用しない                                                                                                                           |
| DBインスタンスクラス    | db.r6i.large                         | 扱うデータはテキストのためDB負荷はそこまでかからないはずなので同時接続1,800人であっても、テキストデータのキャッシュには8GBメモリで十分と判断したため |
| マルチAZ配置            | はい                                 | Writer 1台 + Reader 1〜3台（自動スケール）                                                                                                           |
| VPC                     | kawausolms-prod-vpc                  |                                                                                                                                                      |
| DBサブネットグループ    | kawausolms-prod-rds-subnet-group     |                                                                                                                                                      |
| パブリックアクセス      | なし                                 |                                                                                                                                                      |
| VPCセキュリティグループ | kawausolms-prod-sg-rds               |                                                                                                                                                      |
| データベースポート      | 3306                                 |                                                                                                                                                      |
| データベース認証        | パスワード認証                       |                                                                                                                                                      |
| IAMデータベース認証     | 無効                                 |                                                                                                                                                      |
| 暗号化                  | 有効                                 | AWS KMS                                                                                                                                              |
| 拡張モニタリング        | 有効                                 |                                                                                                                                                      |
| 拡張モニタリング粒度    | 60秒                                 |                                                                                                                                                      |
| 削除保護                | 有効                                 |                                                                                                                                                      |

**バックアップ:**

| 項目                       | 設定値          | 備考                                       |
| -------------------------- | --------------- | ------------------------------------------ |
| 自動バックアップ           | 有効            | Aurora標準機能、必須                       |
| バックアップ保持期間       | 7日間           | コストと復旧要件のバランス                 |
| バックアップウィンドウ     | 02:00-03:00 JST | アクセス最小時間帯、メンテナンスと重複回避 |
| ポイントインタイムリカバリ | 有効            | 5分以内の任意の時点に復元可能              |

**メンテナンス:**

| 項目                                 | 設定値                 | 備考               |
| ------------------------------------ | ---------------------- | ------------------ |
| メンテナンスウィンドウ               | 土曜日 03:00-04:00 JST | アクセス最小時間帯 |
| マイナーバージョン自動アップグレード | 有効                   |                    |

**ログのエクスポート:**

| 項目             | 設定値          | 備考                                                                                                             |
| ---------------- | --------------- | ---------------------------------------------------------------------------------------------------------------- |
| エラーログ       | 有効            | DBエラー情報の記録、障害調査に必須                                                                               |
| スロークエリログ | 有効            | 処理に時間がかかるSQLの記録、パフォーマンス問題特定                                                              |
| 一般ログ         | 無効            |                                                                                                                  |
| 監査ログ         | 無効            |                                                                                                                  |
| ログ出力先       | CloudWatch Logs | エラーログとスロークエリログをCloudWatch Logsに出力                                                              |
| ロググループ     | 自動作成        | /aws/rds/cluster/kawausolms-prod-aurora-cluster/error, /aws/rds/cluster/kawausolms-prod-aurora-cluster/slowquery |
| ログ保持期間     | 7日             | CloudWatch Logsでの保持期間                                                                                      |

**DBクラスターパラメータグループ:**

| 項目            | 設定値 | 備考 |
| --------------- | ------ | ---- |
| long_query_time | 1      |      |

### Aurora Replica Auto Scaling

| 項目                       | 設定値                                | 備考               |
| -------------------------- | ------------------------------------- | ------------------ |
| ポリシー名                 | kawausolms-prod-aurora-scaling-policy |                    |
| ターゲットメトリクス       | 平均CPU使用率                         |                    |
| ターゲット値               | 70                                    | 70%                |
| 最小容量                   | 1                                     | 通常時の最小構成   |
| 最大容量                   | 3                                     | ピーク時の最大構成 |
| スケールインクールダウン   | 300秒                                 |                    |
| スケールアウトクールダウン | 300秒                                 |                    |

---

## S3バケット

### S3バケット（教材データ）

| 項目                         | 設定値                   | 備考               |
| ---------------------------- | ------------------------ | ------------------ |
| バケットタイプ               | 汎用                     |                    |
| バケット名                   | kawausolms-prod-contents | グローバルで一意   |
| リージョン                   | ap-northeast-1           |                    |
| オブジェクト所有者バケット名 | ACL 無効 (推奨)          |                    |
| パブリックアクセスをブロック | すべてブロック           |                    |
| バージョニング               | 有効                     | 誤削除・上書き保護 |
| 暗号化                       | 有効（SSE-S3）           | サーバー側暗号化   |

**ライフサイクルルール:**

ルール名: `delete-noncurrent-versions`

| 項目                   | 設定値                                 | 備考                                       |
| ---------------------- | -------------------------------------- | ------------------------------------------ |
| ルールスコープ         | バケット内のすべてのオブジェクト       |                                            |
| 非現行バージョンの削除 | 1日後                                  | 最新バージョンのみ保持、ストレージ容量抑制 |
| ルールスコープを選択   | バケット内のすべてのオブジェクトに適用 |                                            |

### S3バケット（アプリケーションログ）

| 項目                         | 設定値               | 備考               |
| ---------------------------- | -------------------- | ------------------ |
| バケットタイプ               | 汎用                 |                    |
| バケット名                   | kawausolms-prod-logs | グローバルで一意   |
| リージョン                   | ap-northeast-1       |                    |
| オブジェクト所有者バケット名 | ACL 無効 (推奨)      |                    |
| パブリックアクセスをブロック | すべてブロック       |                    |
| バージョニング               | 有効                 | 誤削除・上書き保護 |
| 暗号化                       | 有効（SSE-S3）       | サーバー側暗号化   |

**ライフサイクルルール:**

ルール名: `delete-app-log-noncurrent-versions`

| 項目                         | 設定値                                 | 備考                                       |
| ---------------------------- | -------------------------------------- | ------------------------------------------ |
| ルールスコープ               | バケット内のすべてのオブジェクト       |                                            |
| 非現行バージョンの削除       | 7日後に完全に削除                      | 最新バージョンのみ保持、ストレージ容量抑制 |
| ルールスコープを選択         | バケット内のすべてのオブジェクトに適用 |                                            |
| 現行バージョンの有効期限切れ | 90日後                                 |                                            |

### S3バケット（ALBログ）

| 項目                         | 設定値                   | 備考                             |
| ---------------------------- | ------------------------ | -------------------------------- |
| バケットタイプ               | 汎用                     |                                  |
| バケット名                   | kawausolms-prod-alb-logs | グローバルで一意                 |
| リージョン                   | ap-northeast-1           |                                  |
| オブジェクト所有者バケット名 | ACL 無効 (推奨)          |                                  |
| パブリックアクセスをブロック | すべてブロック           |                                  |
| バージョニング               | 無効                     | ログファイルはバージョン管理不要 |
| 暗号化                       | 有効（SSE-S3）           | サーバー側暗号化                 |

**バケットポリシー:**

```markdown
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "AWS": "arn:aws:iam::582318560864:root"
            },
            "Action": "s3:PutObject",
            "Resource": "arn:aws:s3:::kawausolms-prod-alb-logs/*"
        }
    ]
}

```

**ライフサイクルルール:**

ルール名: `delete-old-alb-logs`

| 項目                 | 設定値                                 | 備考                           |
| -------------------- | -------------------------------------- | ------------------------------ |
| ルールスコープ       | バケット内のすべてのオブジェクト       |                                |
| オブジェクトの削除   | 90日後                                 | ストレージコスト削減、自動削除 |
| ルールスコープを選択 | バケット内のすべてのオブジェクトに適用 |                                |

---

## WAF

### Web ACL基本設定

| 項目                                     | 設定値                    | 備考  |
| ---------------------------------------- | ------------------------- | ----- |
| 名前                                     | kawausolms-prod-waf-acl   |       |
| 保護パック (ウェブ ACL) のリソースタイプ | Application Load Balancer | ALB用 |
| 初期の保護を選択リージョン               | 重要ルール                |       |
| デフォルトアクション                     | Block                     |       |
| CloudWatch メトリクス                    | 有効                      |       |
| サンプルリクエスト                       | 有効                      |       |

### ログ記録

| 項目           | 設定値                       | 備考                |
| -------------- | ---------------------------- | ------------------- |
| ログ記録       | 有効                         |                     |
| ログ送信先     | CloudWatch Logs              |                     |
| ロググループ名 | aws-waf-logs-kawausolms-prod | WAF専用ロググループ |
| ログ保持期間   | 90日                         | セキュリティ監査用  |
| ログフィールド | すべてのフィールド           |                     |

---

## Route 53

### ホストゾーン

| 項目       | 設定値                                   | 備考           |
| ---------- | ---------------------------------------- | -------------- |
| ドメイン名 | [kawausolms.com](http://kawausolms.com/) | メインドメイン |
| タイプ     | パブリック                               |                |
| VPC        | なし                                     |                |

### レコードセット

**Aレコード（ルートドメイン）:**

| 項目                     | 設定値                                   | 備考                      |
| ------------------------ | ---------------------------------------- | ------------------------- |
| レコード名               | [kawausolms.com](http://kawausolms.com/) |                           |
| レコードタイプ           | A                                        |                           |
| エイリアス               | はい                                     |                           |
| エイリアス先             | kawausolms-prod-alb                      | Application Load Balancer |
| ルーティングポリシー     | シンプル                                 |                           |
| ターゲットのヘルスの評価 | はい                                     |                           |

**Aレコード（wwwサブドメイン）:**

| 項目                     | 設定値                                           | 備考                      |
| ------------------------ | ------------------------------------------------ | ------------------------- |
| レコード名               | [www.kawausolms.com](http://www.kawausolms.com/) |                           |
| レコードタイプ           | A                                                |                           |
| エイリアス               | はい                                             |                           |
| エイリアス先             | kawausolms-prod-alb                              | Application Load Balancer |
| ルーティングポリシー     | シンプル                                         |                           |
| ターゲットのヘルスの評価 | はい                                             |                           |

---

## ACM (AWS Certificate Manager)

### ALB用証明書（ap-northeast-1）

| 項目             | 設定値                                   | 備考                           |
| ---------------- | ---------------------------------------- | ------------------------------ |
| ドメイン名       | *.kawausolms.com                         | ワイルドカード証明書           |
| 追加の名前       | [kawausolms.com](http://kawausolms.com/) | ルートドメインも含める         |
| 検証方法         | DNS検証                                  | 自動更新が容易、Route 53と連携 |
| キーアルゴリズム | RSA 2048                                 |                                |
| リージョン       | ap-northeast-1                           | 東京リージョン（ALB用）        |

---

## CloudWatch

### Log Group

| 項目           | 設定値                           | 備考               |
| -------------- | -------------------------------- | ------------------ |
| ロググループ名 | /aws/kawausolms/prod/application | パス形式で階層化   |
| 保持期間       | 7日                              | リアルタイム監視用 |
| ログクラス     | スタンダード                     |                    |
| 暗号化         | 有効（AWS KMS）                  |                    |

### CloudWatch Agent設定（EC2）

| 項目               | 設定値 | 備考               |
| ------------------ | ------ | ------------------ |
| メトリクス収集間隔 | 60秒   |                    |
| メモリ使用率       | 有効   | カスタムメトリクス |
| ディスク使用率     | 有効   | カスタムメトリクス |

CloudWatch Agent設定は以下を参考に
https://dev.classmethod.jp/articles/cloudwatch-in-console-agent-management-ec2/

## CloudWatch Alarms

**EC2 CPU使用率アラーム（Warning）:**

| 項目       | 設定値                          | 備考                       |
| ---------- | ------------------------------- | -------------------------- |
| アラーム名 | kawausolms-prod-ec2-cpu-warning |                            |
| メトリクス | CPUUtilization                  |                            |
| 統計       | Average                         |                            |
| 期間       | 5分                             |                            |
| しきい値   | 70%                             | リソース不足の早期検知     |
| 評価期間   | 2                               |                            |
| アクション | SNS通知                         | kawausolms-prod-sns-alerts |

**EC2 CPU使用率アラーム（Critical）:**

| 項目       | 設定値                           | 備考                       |
| ---------- | -------------------------------- | -------------------------- |
| アラーム名 | kawausolms-prod-ec2-cpu-critical |                            |
| メトリクス | CPUUtilization                   |                            |
| 統計       | Average                          |                            |
| 期間       | 5分                              |                            |
| しきい値   | 85%                              | 緊急対応が必要             |
| 評価期間   | 2                                |                            |
| アクション | SNS通知                          | kawausolms-prod-sns-alerts |

**RDS CPU使用率アラーム:**

| 項目       | 設定値                          | 備考                       |
| ---------- | ------------------------------- | -------------------------- |
| アラーム名 | kawausolms-prod-rds-cpu-warning |                            |
| メトリクス | CPUUtilization                  |                            |
| 統計       | Average                         |                            |
| 期間       | 5分                             |                            |
| しきい値   | 70%                             | リソース不足の早期検知     |
| 評価期間   | 2                               |                            |
| アクション | SNS通知                         | kawausolms-prod-sns-alerts |

**RDS接続数アラーム:**

| 項目       | 設定値                          | 備考                       |
| ---------- | ------------------------------- | -------------------------- |
| アラーム名 | kawausolms-prod-rds-connections |                            |
| メトリクス | DatabaseConnections             |                            |
| 統計       | Average                         |                            |
| 期間       | 5分                             |                            |
| しきい値   | 最大接続数の80%                 | 接続プール枯渇防止         |
| 評価期間   | 2                               |                            |
| アクション | SNS通知                         | kawausolms-prod-sns-alerts |

**EC2 ステータスチェックアラーム（死活監視）:**

| 項目           | 設定値                           | 備考                                   |
| -------------- | -------------------------------- | -------------------------------------- |
| アラーム名     | kawausolms-prod-ec2-status-check |                                        |
| メトリクス     | StatusCheckFailed                | システムまたはインスタンスの失敗を検知 |
| 統計           | Maximum                          |                                        |
| 期間           | 1分                              |                                        |
| しきい値       | >= 1                             | 1回でも失敗したら通知                  |
| 評価期間       | 2                                |                                        |
| アクション     | SNS通知                          | kawausolms-prod-sns-alerts             |
| 復旧アクション | EC2自動復旧（Recover）           | ハードウェア障害時に自動復旧           |

**EC2 メモリ使用率アラーム（Warning）:**

| 項目       | 設定値                             | 備考                                 |
| ---------- | ---------------------------------- | ------------------------------------ |
| アラーム名 | kawausolms-prod-ec2-memory-warning |                                      |
| 名前空間   | CWAgent                            | CloudWatch Agentのカスタムメトリクス |
| メトリクス | mem_used_percent                   | Agentで取得するメモリ使用率          |
| 統計       | Average                            |                                      |
| 期間       | 5分                                |                                      |
| しきい値   | 80%                                | Javaアプリのメモリ枯渇を早期検知     |
| 評価期間   | 2                                  |                                      |
| アクション | SNS通知                            | kawausolms-prod-sns-alerts           |

---

### SNS (Simple Notification Service)

### SNS Topic

| 項目       | 設定値                     | 備考 |
| ---------- | -------------------------- | ---- |
| トピック名 | kawausolms-prod-sns-alerts |      |
| タイプ     | Standard                   |      |
| 表示名     | KawausoLMS Prod Alerts     |      |
| 暗号化     | 有効（AWS KMS）            |      |

### サブスクリプション

| 項目           | 設定値                         | 備考                            |
| -------------- | ------------------------------ | ------------------------------- |
| プロトコル     | Email                          |                                 |
| エンドポイント | alert@kawausolms.com（仮置き） | ※正式なメールアドレスは後日確定 |

---

### AWS Secrets Manager

### シークレット（マスターパスワード）

| 項目               | 設定値                     | 備考                       |
| ------------------ | -------------------------- | -------------------------- |
| シークレット名     | kawausolms-prod-db-master  |                            |
| シークレットタイプ | RDS データベースの認証情報 |                            |
| ユーザー名         | admin                      | 緊急時のみ使用             |
| パスワード         |                            |                            |
| 暗号化キー         | aws/secretsmanager         | デフォルトKMSキー          |
| 自動ローテーション | 無効                       | 手動管理、通常は使用しない |

### シークレット（アプリ用ユーザー）

| 項目               | 設定値                      | 備考                       |
| ------------------ | --------------------------- | -------------------------- |
| シークレット名     | kawausolms-prod-db-app-user |                            |
| シークレットタイプ | RDS データベースの認証情報  |                            |
| ユーザー名         | app_user                    | アプリケーション用ユーザー |
| パスワード         | （自動生成）                |                            |
| 暗号化キー         | aws/secretsmanager          | デフォルトKMSキー          |
| 自動ローテーション | 有効                        |                            |
| ローテーション間隔 | 90日                        |                            |

---

### AWS Data Lifecycle Manager (DLM)

### EBSスナップショットポリシー

| 項目                     | 設定値                              | 備考                             |
| ------------------------ | ----------------------------------- | -------------------------------- |
| ポリシー名               | kawausolms-prod-ebs-snapshot-policy |                                  |
| ポリシータイプ           | EBS snapshot policy                 |                                  |
| リソースタイプ           | Volume                              |                                  |
| ターゲットタグ           | Name: kawausolms-prod-*             | Auto Scalingで起動されるEC2のEBS |
| スケジュール名           | Daily snapshot                      |                                  |
| 頻度                     | Daily                               |                                  |
| 開始時刻                 | 04:00 JST                           | 深夜帯に自動取得                 |
| 保持タイプ               | Count                               |                                  |
| 保持数                   | 3                                   |                                  |
| タグのコピー             | 有効                                |                                  |
| クロスリージョンコピー   | 無効                                |                                  |
| 高速スナップショット復元 | 無効                                |                                  |

---

## AWS Budgets

### コスト予算

| 項目       | 設定値                 | 備考           |
| ---------- | ---------------------- | -------------- |
| 予算名     | kawausolms-prod-budget |                |
| 予算タイプ | コスト予算             |                |
| 期間       | 月次                   | 毎月リセット   |
| 予算額     | 200,000 JPY            | 月額20万円目安 |
| 開始月     | 運用開始月             |                |
| フィルター | なし                   | アカウント全体 |

### アラート設定

**アラート1（50%到達）:**

| 項目             | 設定値                         | 備考                            |
| ---------------- | ------------------------------ | ------------------------------- |
| アラートしきい値 | 50%                            | 100,000 JPY                     |
| トリガー         | 実際のコスト                   |                                 |
| 通知先           | alert@kawausolms.com（仮置き） | ※正式なメールアドレスは後日確定 |

**アラート2（75%到達）:**

| 項目             | 設定値                         | 備考                            |
| ---------------- | ------------------------------ | ------------------------------- |
| アラートしきい値 | 75%                            | 150,000 JPY                     |
| トリガー         | 実際のコスト                   |                                 |
| 通知先           | alert@kawausolms.com（仮置き） | ※正式なメールアドレスは後日確定 |

**アラート3（100%予測）:**

| 項目             | 設定値                         | 備考                            |
| ---------------- | ------------------------------ | ------------------------------- |
| アラートしきい値 | 100%                           | 200,000 JPY                     |
| トリガー         | 予測コスト                     | 月末までの予測で通知            |
| 通知先           | alert@kawausolms.com（仮置き） | ※正式なメールアドレスは後日確定 |

---
